<!DOCTYPE html>
<html lang="no">
  <head>
    <meta charset="utf-8" />
    <!-- Gjør siden responsiv på mobil -->
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Supabase demo — Meldinger</title>

    <!-- Bootstrap for enkel design og layout -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />

    <!-- Google reCAPTCHA mot spam/boter -->
    <script src="https://www.google.com/recaptcha/api.js" async defer></script>

    <!-- Litt egen CSS-styling -->
    <style>
      body {
        background: #f8fafc;
      }
      .card-elev {
        border: 1px solid #e9ecef;
        border-radius: 1rem;
      }
      .muted {
        color: #6c757d;
      }
      .message .time {
        font-size: 0.8rem;
        color: #6c757d;
      }
    </style>
  </head>

  <body>
    <!-- Toppmeny -->
    <nav class="navbar navbar-expand-md bg-white border-bottom">
      <div class="container">
        <a class="navbar-brand fw-semibold" href="#">Supabase demo</a>
      </div>
    </nav>

    <main class="container my-4">
      <!-- Overskrift og forklaring -->
      <header class="text-center mb-4">
        <h1 class="h4 fw-bold">Navn + kort melding</h1>
        <p class="text-muted mb-0">Skriver til databasen og viser under.</p>
      </header>

      <section class="row g-4">
        <!-- Skjema for innsending -->
        <div class="col-12 col-lg-5">
          <div class="card card-elev shadow-sm">
            <div class="card-body">
              <h2 class="h6 mb-3">Send inn</h2>

              <!-- Skjema med validering -->
              <form id="form" class="needs-validation" novalidate>
                <div class="mb-3">
                  <label class="form-label">Navn</label>
                  <input
                    id="name"
                    class="form-control"
                    minlength="2"
                    maxlength="30"
                    required
                  />
                </div>

                <div class="mb-3">
                  <label class="form-label">Kort melding</label>
                  <input
                    id="content"
                    class="form-control"
                    maxlength="140"
                    required
                  />
                </div>

                <!-- CAPTCHA for å stoppe roboter -->
                <div class="mb-3">
                  <div
                    class="g-recaptcha"
                    data-sitekey="6LeIxAcTAAAAAJcZVRqyHh71UMIEGNQ_MXjiZKhI"
                  ></div>
                  <div
                    class="invalid-feedback d-block"
                    id="captcha-error"
                    style="display: none"
                  >
                    Du må bekrefte at du ikke er en robot.
                  </div>
                </div>

                <button class="btn btn-primary w-100" type="submit">
                  Lagre
                </button>

                <!-- Statusmelding -->
                <div id="status" class="form-text mt-2 muted">Klar</div>
              </form>
            </div>
          </div>
        </div>

        <!-- Viser lagrede meldinger -->
        <div class="col-12 col-lg-7">
          <div class="card card-elev shadow-sm">
            <div class="card-body">
              <h2 class="h6 mb-2">Meldinger</h2>
              <span class="badge text-bg-light"
                ><span id="count">0</span> stk</span
              >
              <div id="msgs" class="d-grid gap-2"></div>
            </div>
          </div>
        </div>
      </section>
    </main>

    <!-- Supabase bibliotek -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <script>
      // Kobler til Supabase-databasen
      const SUPABASE_URL = "DIN_URL";
      const SUPABASE_ANON_KEY = "DIN_KEY";
      const supabase = window.supabase.createClient(
        SUPABASE_URL,
        SUPABASE_ANON_KEY
      );

      // Henter elementer fra siden
      const form = document.getElementById("form");
      const nameInput = document.getElementById("name");
      const contentInput = document.getElementById("content");
      const msgsEl = document.getElementById("msgs");
      const statusEl = document.getElementById("status");
      const countEl = document.getElementById("count");

      // Sikrer tekst mot HTML-injeksjon
      function esc(s) {
        return (s || "").replace(
          /[<>&"']/g,
          (c) =>
            ({
              "<": "&lt;",
              ">": "&gt;",
              "&": "&amp;",
              '"': "&quot;",
              "'": "&#39;",
            }[c])
        );
      }

      // Deler opp navn og melding fra databasen
      function parseRow(r) {
        const raw = r.content || "";
        const i = raw.indexOf("::");
        return i === -1
          ? { name: "Anonym", message: raw, created_at: r.created_at }
          : {
              name: raw.slice(0, i),
              message: raw.slice(i + 2),
              created_at: r.created_at,
            };
      }

      // Henter og viser meldinger
      async function loadMessages() {
        statusEl.textContent = "Laster...";
        const { data } = await supabase
          .from("messages")
          .select("*")
          .order("created_at", { ascending: false })
          .limit(100);

        countEl.textContent = (data || []).length;

        msgsEl.innerHTML = (data || [])
          .map((r) => {
            const it = parseRow(r);
            return `<div><strong>${esc(it.name)}</strong>: ${esc(
              it.message
            )}</div>`;
          })
          .join("");

        statusEl.textContent = "Klar";
      }

      // Når skjema sendes inn
      form.addEventListener("submit", async (e) => {
        e.preventDefault();

        // CAPTCHA-sjekk
        if (!grecaptcha.getResponse()) {
          document.getElementById("captcha-error").style.display = "block";
          return;
        }

        const name = nameInput.value.trim();
        const msg = contentInput.value.trim();

        // Lagrer til databasen
        await supabase.from("messages").insert({ content: name + "::" + msg });

        form.reset();
        grecaptcha.reset();
        loadMessages();
      });

      // Laster meldinger ved start
      loadMessages();
    </script>
  </body>
</html>
